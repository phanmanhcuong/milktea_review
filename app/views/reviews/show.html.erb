<div class="container" style="margin-top: 10vh">
  <div class="review-header">
    <div class="row">
      <% if (@cur_review.image.url != nil) %>
        <div class="col-sm-5"
          style="background-image: url('<%= image_path(@cur_review.image.url) %>'); height: 300px;
          background-size: cover; background-position: center; background-repeat: no-repeat;">
        </div>
      <% else %>
        <div class="col-sm-5" style="background-image: url('http://img1.cookinglight.timeinc.net/sites/default/files/styles/4_3_horizontal_-_1200x900/public/image/2016/12/main/grapefruit-soda.jpg?itok=VOZWdiFr '); height: 300px;
          background-size: cover; background-position: center; background-repeat: no-repeat;">
        </div>
      <% end %>
      <%= render "right_header" %>
    </div>
  </div>

  <div class="review-field" style="background: #ffffff; min-height: 150px;
    padding: 10px;font-style: italic; font-size:1.2em;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24)">
    <%= @cur_review.content %>
  </div>

  <%= render "comment" %>
</div>

<script type="text/javascript" charset="utf-8">
$('.main-rating').on('click', function(){
  $('.rating').toggleClass('hide');
});

$('.review-btn').on('click', function() {
  $(this).addClass("active");
  $('.comment-btn').removeClass('active');
  $('.review-field').removeClass('hide');
  $('.comment-field').addClass('hide');
});

$('.comment-btn').on('click', function() {
  $(this).addClass("active");
  $('.review-btn').removeClass('active');
  $('.review-field').addClass('hide');
  $('.comment-field').removeClass('hide');
});

$(document).on('click', '.btn-comment', function() {
  var cmt_content = $('#cmt-content-field').val();
  $('#cmt-content-field').val('');
  $.ajax({
    beforeSend: function(xhr){
      xhr.setRequestHeader('X-CSRF-Token',
        $('meta[name="csrf-token"]').attr('content'));
    },
    type:'POST',
    url: '/comments',
    data: {
      comment: {
        content: cmt_content,
        review_id: <%= @cur_review.id %>,
        user_id: <%= current_user.id %>
      }
    }
  }).success(function(d){
    $('.cur_comment').load(document.URL + ' .cur_comment');
  });
});

$(document).on('click', '.delete-comment', function() {
  var url = '/comments/' + $(this).attr('data-id');
  $.ajax({
    beforeSend: function(xhr){
      xhr.setRequestHeader('X-CSRF-Token',
        $('meta[name="csrf-token"]').attr('content'));
    },
    type:'DELETE',
    url: url,
  }).success(function(d){
    $('.cur_comment').load(document.URL + ' .cur_comment');
  });
});

$(document).on('click', '.edit-comment', function() {
  var comment_id = $(this).attr('data-id');
  var cur_content = $(this).parent().next().text();
  $(this).parent().parent().hide();
  $('#cmt-content-field').val(cur_content);
  $('.btn-comment').hide();
  $('.btn-edit').removeClass('hide').on('click', function() {
    var new_content = $('#cmt-content-field').val();
    var edit_url = /comments/+comment_id;
    $.ajax({
      beforeSend: function(xhr){
        xhr.setRequestHeader('X-CSRF-Token',
          $('meta[name="csrf-token"]').attr('content'));
      },
      type:'PUT',
      url: edit_url,
      data: {
        comment: {
          content: new_content,
        }
      }
    }).success(function(d){
      $('.cur_comment').load(document.URL + ' .cur_comment');
      $('.btn-edit').addClass('hide');
      $('.btn-comment').show();
      $('#cmt-content-field').val('');
    });
  });
});

$(document).on('click', '#try-it', function() {
  $.ajax({
    beforeSend: function(xhr){
      xhr.setRequestHeader('X-CSRF-Token',
        $('meta[name="csrf-token"]').attr('content'));
    },
    type:'POST',
    url: '/likes',
    data: {
      like: {
        user_id: <%= current_user.id %>,
        review_id: <%= @cur_review.id %>,
      }
    }
  }).success(function(d){
    $('#like_field').load(document.URL + ' #like_field');
    $('.try-count').load(document.URL + ' .try-count-cont');
  });
});

$(document).on('click', '#un-try-it', function() {
  var url_delete = '/likes/' + <%= @cur_review.id %>;
  $.ajax({
    beforeSend: function(xhr){
      xhr.setRequestHeader('X-CSRF-Token',
        $('meta[name="csrf-token"]').attr('content'));
    },
    type:'DELETE',
    url: url_delete
  }).success(function(d){
    $('#like_field').load(document.URL + ' #like_field');
    $('.try-count').load(document.URL + ' .try-count-cont');
  });
});
</script>
